<!DOCTYPE html>
<html lang="en">
  <head>
  <!-- anchors for headings -->
  <script src="../anchor.min.js"></script>

  
    <!-- Google Analytics -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-142322478-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-142322478-2');
</script>
    
    
    <!-- Katex Math -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">

    <!-- The loading of KaTeX is deferred to speed up page rendering -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
  
    <!-- To automatically render math in text elements, include the auto-render extension: -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body, {delimiters: [{ left: '$$', right: '$$', display: true },{ left: '\\[', right: '\\]', display: true },{ left: '$', right: '$', display: true },{ left: '\\(', right: '\\)', display: false },{ left: '$$$', right: '$$$', display: true }]});"></script>
<!-- END MATH --> 

    <!-- META INFO -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Danny Denenberg's home page on the internet with a programming blog." />

          <!-- END META INFO -->
  <title>
    
    JSON Web Tokens in Express.js &middot; Danny Denenberg
    
  </title>

  <!-- Font Awesome Icon Support -->
 <script src="https://kit.fontawesome.com/b0b051f3df.js" crossorigin="anonymous"></script>
  </head>


  <link rel="stylesheet" href="/styles.css" />
  <link
    rel="apple-touch-icon-precomposed"
    sizes="144x144"
    href="/public/apple-touch-icon-precomposed.png"
  />
  <link rel="shortcut icon" href="/public/favicon.ico" />
  <link
    rel="alternate"
    type="application/atom+xml"
    title="Danny Denenberg"
    href="/atom.xml"
  />


</head>


  <body>
    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">Danny Denenberg</a>
          <small></small>
        </h3>

         &nbsp;&nbsp;&nbsp;<span
          class="nav-bar-item"
          ><a href="/about/">About</a></span
        >
         &nbsp;&nbsp;&nbsp;<span
          class="nav-bar-item"
          ><a href="/projects">Projects</a></span
        >
        
      </header>

      <main>
        <article class="post">
  <h1 class="post-title">JSON Web Tokens in Express.js</h1>
  <time datetime="2020-02-14T00:00:00-06:00" class="post-date"
    >February 14, 2020</time
  >

  <p>This article is written on the applications of <a href="https://jwt.io/">JSON Web Tokens</a> in a server-client relationship using Node.js and plain JavaScript. If you want to learn about the concepts behind JWT, I could not recommend <a href="https://medium.com/swlh/why-do-we-need-the-json-web-token-jwt-in-the-modern-web-8490a7284482">Mariano Calandraâ€™s Medium post</a> more.</p>

<p>To install JSON Web Tokens in your project, run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>yarn add jsonwebtoken
</code></pre></div></div>

<p>And import it into your files like so:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"jsonwebtoken"</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="authenticating-a-token">Authenticating a token</h3>

<p>There are many ways to go about implementing a JWT authentication system in an <a href="https://expressjs.com/">Express.js</a> application. What suites me best, though, it to utilize Expressâ€™ middleware functionality. How it works is when a request is made to a specific route, you can have the <code class="highlighter-rouge">(req, res)</code> variables sent to an intermediary function before the one specified in the <code class="highlighter-rouge">app.get((req, res) =&gt; {})</code>.</p>

<p>The piece of middleware is simply a function that takes parameters of <code class="highlighter-rouge">(req, res, next)</code>. The <code class="highlighter-rouge">req</code> is the sent request (<a href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">get, post, delete, use, etc.</a>), the <code class="highlighter-rouge">res</code> is the response that can be sent back to the user in a multitude of ways (res.sendStatus(200), res.json(), etc), and <code class="highlighter-rouge">next</code> is a function that can be called to move the execution past the piece of middleware and into the actual <code class="highlighter-rouge">app.get</code> server response.</p>

<p>Here is the middleware function I wrote for my auth needs:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">authenticateToken</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Gather the jwt access token from the request header</span>
  <span class="kd">const</span> <span class="nx">authHeader</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">'authorization'</span><span class="p">]</span>
  <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">authHeader</span> <span class="o">&amp;&amp;</span> <span class="nx">authHeader</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span> <span class="c1">// if there isn't any token</span>

  <span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ACCESS_TOKEN_SECRET</span> <span class="k">as</span> <span class="nx">string</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">:</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">user</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">user</span>
    <span class="nx">next</span><span class="p">()</span> <span class="c1">// pass the execution off to whatever request the client intended</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>An example request would look something like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET https://mysite:4000/api/userOrders
Authorization: Bearer JWT_ACCESS_TOKEN
</code></pre></div></div>

<p>And, an example of a request that would use that piece of middleware would look like this:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/api/userOrders'</span><span class="p">,</span> <span class="nx">authenticateToken</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// executes after authenticateToken</span>
  <span class="p">...</span>
<span class="p">})</span>
<span class="p">...</span>
</code></pre></div></div>

<h3 id="generating-a-token">Generating a token</h3>

<p>Backtracking slightly, we will now discuss how to actually generate and send a jwt token to the client.</p>

<p>To accomplish this (this being signing a token), you need to have 3 pieces of information:</p>

<ol>
  <li>The token secret</li>
  <li>The piece of data to hash in the token</li>
  <li>The token expire time</li>
</ol>

<p>The <strong>token secret</strong> is simply a super long, super random string used to encrypt and decrypt the data. To generate this secret, I recommend using Nodeâ€™s <code class="highlighter-rouge">crypto</code> lib, like so:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'crypto'</span><span class="p">).</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">64</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">)</span>
<span class="c1">// '09f26e402586e2faa8da4c98a35f1b20d6b033c6097befa8be3486a829587fe2f90a832bd3ff9d42710a4da095a2ce285b009f0c3730cd9b8e1af3eb84df6611'</span>
</code></pre></div></div>

<p>Now store this secret in the your projectâ€™s .env file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">ACCESS_TOKEN_SECRET</span><span class="o">=</span>7bc78545b1a3923cc1e1e19523fd5c3f20b409509...
</code></pre></div></div>

<p>To bring this token into a Node file and to use it, you have to use â€˜dotenvâ€™:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">dotenv</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"dotenv"</span><span class="p">);</span>

<span class="c1">// get config vars</span>
<span class="nx">dotenv</span><span class="p">.</span><span class="nx">config</span><span class="p">();</span>

<span class="c1">// access config var</span>
<span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ACCESS_TOKEN_SECRET</span><span class="p">;</span>
</code></pre></div></div>

<p>The <strong>piece of data</strong> that you hash in your token can be something as simply as a user ID or username, all the way up to something much more complex. In either case, it should be an <em>identifier</em> for a <em>specific user</em>.</p>

<p>The <strong>token expire time</strong> is a string, such as â€˜1800sâ€™ that details how long until the token will be invalid.</p>

<p>So, here is my function for signing tokens:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// username is in the form {username: "my cool username"}</span>
<span class="kd">function</span> <span class="nx">generateAccessToken</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// expires after half and hour (1800 seconds = 30 minutes)</span>
  <span class="k">return</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ACCESS_TOKEN_SECRET</span> <span class="k">as</span> <span class="nx">string</span><span class="p">,</span> <span class="p">{</span> <span class="na">expiresIn</span><span class="p">:</span> <span class="s1">'1800s'</span> <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This can be sent back from a request to sign in or log in a user.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/api/creteNewUser'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">generateAccessToken</span><span class="p">({</span> <span class="na">username</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span> <span class="p">});</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
  <span class="p">...</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="client-side-token-handling">Client side token handling</h3>

<p>When the client receives the token, they should store it in a cookie like so:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span> <span class="c1">// get token from fetch request</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="s2">`token=</span><span class="p">${</span><span class="nx">token</span><span class="p">}</span><span class="s2">`</span> <span class="c1">// set token in cookie</span>
<span class="p">...</span>
</code></pre></div></div>

<p>It that simple!</p>

<p>I will also put below some utility functions for retrieving and setting tokens in cookies effectively and using cookie expires times.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// create a new cookie</span>
<span class="kd">function</span> <span class="nx">setCookie</span><span class="p">(</span><span class="nx">cname</span><span class="p">,</span> <span class="nx">cvalue</span><span class="p">,</span> <span class="nx">exdays</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
  <span class="nx">d</span><span class="p">.</span><span class="nx">setTime</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="nx">exdays</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">expires</span> <span class="o">=</span> <span class="s2">"expires="</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">toUTCString</span><span class="p">();</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="nx">cname</span> <span class="o">+</span> <span class="s2">"="</span> <span class="o">+</span> <span class="nx">cvalue</span> <span class="o">+</span> <span class="s2">";"</span> <span class="o">+</span> <span class="nx">expires</span> <span class="o">+</span> <span class="s2">";path=/"</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// get the value of a cookie with a certain name</span>
<span class="kd">function</span> <span class="nx">getCookie</span><span class="p">(</span><span class="nx">cname</span><span class="p">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">cname</span> <span class="o">+</span> <span class="s2">"="</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">ca</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">";"</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ca</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">ca</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="s2">" "</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="s2">""</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

</article>

<hr />

<div class="qna">
  <h2>Questions?</h2>
  <p>
    Have a question about this post, the right way to tell a theater joke ðŸŽ­, or
    anything else? Ask away on
    <a href="https://github.com/dannydenenberg/ama" target="_blank"
      >my AMA repo</a
    >
    or shoot me an <a href="/about" target="_blank">email</a>.
  </p>
</div>


<!-- 
<aside class="related">
  <h3>Related posts</h3>
  <ul class="related-posts">
    
    <li>
      <a href="/activation-functions-comparison">
        Activation functions comparison
        <small
          ><time datetime="2020-02-12T00:00:00-06:00">12 Feb 2020</time></small
        >
      </a>
    </li>
    
    <li>
      <a href="/complete-neural-nets">
        Complete approach to neural networks
        <small
          ><time datetime="2020-01-02T00:00:00-06:00">02 Jan 2020</time></small
        >
      </a>
    </li>
    
    <li>
      <a href="/gradient-descent-univar-lr">
        Gradient descent for univariate linear regression
        <small
          ><time datetime="2019-09-20T00:00:00-05:00">20 Sep 2019</time></small
        >
      </a>
    </li>
    
  </ul>
</aside>
 -->

      </main>

      <div class="footer" style="text-align: center">
  <a
    style="text-decoration: none"
    href="https://github.com/dannydenenberg/dannydenenberg.github.io"
    ><3</a
  >
</div>

    </div>

    

    <!-- PUt the anchors on headings -->
    <script>
      anchors.options = {
        placement: "left",
        // visible: "always"
        icon: "Â§"
      };
      anchors.add("main h2, main h3, main h4, main h5");
    </script>
  </body>
</html>
